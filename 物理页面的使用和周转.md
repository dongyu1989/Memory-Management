# Memory-Management

交换设备(通常是磁盘，也可以是普通文件)的每个物理页面也要在内存中有个相应的数据结构(或者说“户口”)，不过那些要简单得多，实际上只是一个计数，表示该页面是否已被分配使用，以及有几个用户在共享这个页面。对盘上页面的管理是按文件或磁盘设备来进行的。内核中定义一个swap_info_struct数据结构，用以描述和管理用于页面交换的文件和设备。它的定义包含在include/linux/swap.h中：

![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/images/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170410a.jpg)

其中的指针swap_map指向一个数组，该数组中的每一个无符号短整数即代表磁盘上的一个物理页面，而数组的下标则决定了该页面在磁盘或文件上的位置。数组的大小取决于pages，他表示该页面交换设备或文件的大小。设备上（或文件中，设备也是一种文件，下同）的第一个页面，也即swap_map[0]所代表的那个页面是不用于页面交换的，它包含了该设备或文件自身的一些信息以及一个表明那些页面可供使用的位图。这些信息最初是在把改设备格式化成页面交换区时设置的。根据不同的页面交换区格式，还有一些其他页面也不供页面交换使用。这些页面都集中在开头和结尾两个地方，所以swap_info_struct结构中的lowest_bit和highest_bit就说明文件中从什么地方开始到什么地方为止是供页面交换使用的。另一个字段max则表示该设备或文件中最大的页面号，也就是设备或文件的物理大小。

由于存储介质是转动的磁盘，将地址连续的也页面存储在连续的磁盘扇区中不见得是最有效的方法，所以在分配盘上页面空间时尽可能按集群(cluster)方式进行，而字段cluster_next和cluster_nr就是为此而设置的。

Linux内核允许使用多个页面交换设备（或文件），所以在内核中建立了一个swap_info_struct结构的阵列（数组）swap_info:

```c
   struct swap_info_struct swap_info[MAX_SWAPFILES];
``` 

同时，还设立一个队列swap_list,将各个可以分配物理页面的磁盘设备或文件的swap_info_struct结构按优先级高低链接在一起。

```c
    struct swap_list_t swap_list = {-1, -1};
    struct swap_list_t {
           int head;
           int next;
     }
``` 

开始时队列为空，所以head和next均为-1。当系统调用swap_on()指定一个文件用于页面交换时，就将该文件的swap_info_struct结构链入队列中。

就像通过pte_t数据结构（页面表项）将物理内存页面和虚存页面建立联系一样，盘上页面也有这么一个swap_entry_t数据结构：

```c
   typedef struct {
           unsigned long val;
  } swp_entry_t;
```

可见，一个swap_entry_t结构实际上是一个32位无符号整数。但是，这个32位整数实际上分成三个部分：

![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/images/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170410b.jpg)

这里offset表示页面在一个磁盘设备或文件中的位置，也就是文件中的逻辑页面号；而type则是指该页面在哪一个文件中，是个序号。这个位段的命名很容易引起误解，估计这是从pte_t结构中过来的。

当一个页面在内存中是，页面表中的表项pte_t的最低位P标志为1，表示页面在内存中，而其余各位指明物理内存页面的地址及页面的属性。而当一个页面在磁盘上时，则相应的页面表项不在指向一个物理内存页面，而是变成一个swap_entry_t"表项"，指示着这个页面的去向。由于此时其最低位为0，表示页面不在内存，所以CPU中的MMU
单元对其各位都忽略不顾，而留系统软件自己来加以解释。在linux内核中，就用它来唯一地确定一个页面在盘上的位置，包括在哪一个文件或设备，以及页面在此文件中的相对位置。

![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/images/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170410c.jpg)
![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/images/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170410d.jpg)
