# Memory-Management

交换设备(通常是磁盘，也可以是普通文件)的每个物理页面也要在内存中有个相应的数据结构(或者说“户口”)，不过那些要简单得多，实际上只是一个计数，表示该页面是否已被分配使用，以及有几个用户在共享这个页面。对盘上页面的管理是按文件或磁盘设备来进行的。内核中定义一个swap_info_struct数据结构，用以描述和管理用于页面交换的文件和设备。它的定义包含在include/linux/swap.h中：

![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/images/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170410a.jpg)

其中的指针swap_map指向一个数组，该数组中的每一个无符号短整数即代表磁盘上的一个物理页面，而数组的下标则决定了该页面在磁盘或文件上的位置。数组的大小取决于pages，他表示该页面交换设备或文件的大小。设备上（或文件中，设备也是一种文件，下同）的第一个页面，也即swap_map[0]所代表的那个页面是不用于页面交换的，它包含了该设备或文件自身的一些信息以及一个表明那些页面可供使用的位图。这些信息最初是在把改设备格式化成页面交换区时设置的。根据不同的页面交换区格式，还有一些其他页面也不供页面交换使用。这些页面都集中在开头和结尾两个地方，所以swap_info_struct结构中的lowest_bit和highest_bit就说明文件中从什么地方开始到什么地方为止是供页面交换使用的。另一个字段max则表示该设备或文件中最大的页面号，也就是设备或文件的物理大小。

由于存储介质是转动的磁盘，将地址连续的也页面存储在连续的磁盘扇区中不见得是最有效的方法，所以在分配盘上页面空间时尽可能按集群(cluster)方式进行，而字段cluster_next和cluster_nr就是为此而设置的。

Linux内核允许使用多个页面交换设备（或文件），所以在内核中建立了一个swap_info_struct结构的阵列（数组）swap_info:

```c
   struct swap_info_struct swap_info[MAX_SWAPFILES];
``` 

同时，还设立一个队列swap_list,将各个可以分配物理页面的磁盘设备或文件的swap_info_struct结构按优先级高低链接在一起。

```c
    struct swap_list_t swap_list = {-1, -1};
    struct swap_list_t {
           int head;
           int next;
     }
``` 
