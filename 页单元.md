# Memory-Management

硬件的分页单元
------------
分页单元(paging unit)把线性地址转换成物理地址。它把所请求的存取类型和线性地址的存取权限相比，如果这次内存存取是无效的，则产生一个页错误异常。

为了效率起见，线性地址被分成以固定长度为单位的组，称为页。页内连续的线性地址被映射到连续的物理地址中。用这种方式内核可以指定物理地址和页的存取权限，以代替它所包含的全部线性地址的存取权限。

把线性地址映射到物理地址的数据结构称为页表(page table)。页表存放在主存中，并在启动分页单元以前必须由内核对页表进行适当的初始化。

在intel处理器，通过设置cr0寄存器的PG标志启动分页。当PG=0时，线性地址被解释成物理地址。

![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170402a.jpg "分页单元")

32位的线性地址被分成3个域，10位：目录，10位：页表，12位：偏移量。

线性地址的转换分为两步完成，每一步都是基于一种转换表，第一种转换表称为页目录表(page directory)，第二种转换表称为页表(page table)。

使用这两种二级模式的目的在于减少每个进程页表所需RAM的数量。如果使用简单的一级页表，那将需要高达2的20次幂个表象（也就是，在每个4个字节时，需要4MB RAM）来表示每个进程的页表（如果进程使用全部4GB线性地址空间），即使一个进程不使用那个范围内的所有地址。二级模式通过只为进程实际使用的那些虚拟内存区请求页表来减少内存容量。

每个活动进程必须有一个分配给它的页目录。不过，没有必要马上为进程的所有页表都分配RAM。只有在进程实际需要一个页表时才给页表分配RAM会更为有效率。

页目录项和页表项有同样的结构，每项都包含下面的字段：

Present标志：如果被置为1，所指的页(或页表)就在主存中；如果该标志为0，则这一页不在主存中，此时这个表项剩余的位可由操作系统用于自己的目的。如果执行一个地址所需的页表项或页目录项中Present标志被清0，那个分页单元就把该线性地址放在控制寄存器cr2中，并产生14号中断：缺页异常。

包含页框物理地址最高20位的字段：由于每一个页框有4KB的容量，它的物理地址必须是4096的倍数，因此物理地址的最低12位总是0。

Accessed标志：每当分页单元对相应页框进行寻址时就设置这个标记。当选中的页被交换出去时，这一标志就可以由操作系统使用。分页单元从来不重置这个标记，而必须由操作系统去做。

Dirty标记：只应用于页表项中。每当对一个页框进行写操作时就设置这个标记。与Accessed标记一样，当选中的页被交换出去时，这一标记就可以由操作系统使用。分页单元从来不重置这个标记，而是必须由操作系统去做。

User/Supervisor标记：含有访问页或页表所需的特权级。

PCD和PWT标记：控制硬件高速缓存处理页或页表的方式。

Page Size标记：应用于页目录项。如果设置为1，则页目录指的是2MB或4MB的页框。

Global标记：只应用页表项。这个标记是在Pentium Pro中引入的，用来防止常用页从TLB高速缓存中刷新出来。
